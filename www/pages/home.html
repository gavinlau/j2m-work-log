<template>
   <div class="page" data-name="home"><!--page start-->
          <!-- Top Navbar -->
          <div class="navbar">
            <div class="navbar-inner">
             
              <div class="title sliding">日志</div>
              
            </div>
          </div>
         <!--Fab-->
		  
		   <div class="fab fab-left-bottom">
			<a href="/wl-add/">
			  <i class="icon f7-icons ios-only">add</i>
			  <i class="icon f7-icons ios-only">close</i>
			  <i class="icon material-icons md-only">add</i>
			  <i class="icon material-icons md-only">close</i>
			</a>
		
		  </div>
          <!-- Scrollable page content-->
          <div class="page-content"><!--page content start  hide-navbar-on-scroll-->
		         
				 <!--Calendar-->
				 <div id="demo-calendar-inline-container"></div>
				 <!--User list-->
                 
				 <div class="row">
					<!-- Each "cell" has col-[widht in percents] class -->
					<div class="col-100">
						<a class="item-link smart-select smart-select-init" id="ss-user-list" data-open-in="popover">
							<select name="selUser">
							  <option value="{{firstName}}">{{firstName}}</option>
							</select>
							<div class="item-content">
							  <div class="item-inner">
								<div class="item-title"></div>
							  </div>
							</div>
						 </a>
					 </div>
				 </div>
				 <!--List-->
				<div class="list virtual-list media-list searchbar-found"></div>
					
          </div><!--page content end-->
		
    </div><!--page end-->
</template>
<style scoped>
  
   

</style>
<script>
    // script must return component object
  return {
   
	// Lifecycle Hooks
    beforeCreate() {
	  var _this=this;
      console.log('componentBeforeCreate', this)
    },
    created() {
      console.log('componentCreated', this)
    },
    beforeMount() {
      console.log('componentBeforeMount', this)
    },
    mounted() {
      console.log('componentMounted', this);
    },
    beforeDestroy() {
      console.log('componentBeforeDestroy', this);
    },
    destroyed() {
      console.log('componentDestroyed', this);
    },
     // Page Events
    on: {
      pageMounted: function(e, page) {
        console.log('pageMounted', page);
		
      },
      pageInit: function(e, page) {
        console.log('pageInit', page);
	    this.initUI();
		
      },
      pageBeforeIn: function(e, page) {//Gavin it can grap the ui instance
        console.log('pageBeforeIn', page);
		//init the ui data
		app.toolbar.show('.toolbar');
		this.initUIData();
		this.statusChanged();	  
      },
      pageAfterIn: function(e, page) {
	    
      },
      pageBeforeOut: function(e, page) {
        console.log('pageBeforeOut', page);
      },
      pageAfterOut: function(e, page) {
        console.log('pageAfterOut', page);
      },
      pageBeforeRemove: function(e, page) {
        console.log('pageBeforeRemove', page);
      },
	  
    },
	data: function () {
      return {
        selectedDate: new Date(),
		selectedUserId:'',
		firstName:app.data.userId,
		listParam:{
                 cmd:"{'/j2-easyui-encalendar-portlet.encalendar/get-default-calendar-booking-by-date':{}}", 
				 p_auth:app.data.p_auth,
				 userId:app.data.userId,//For no selected user,It will be override by userDg loadSuccess  20434
				 startTime:0,
				 endTime:10000000000000,
				 locale:'zh_CN',
				 page:1,
				 rows:200
				},
		userlistParam:{
					 cmd:"{'/J2eecn-Api-hook.japi/get-users-and-teams-by-group-id':{}}",
					 p_auth: app.data.p_auth,
					 qName:'',
					 groupId:249479,
					 page:1,
					 rows:20
				 },
		users: [],
      }
    },
	methods: {
      openAlert: function () {
        var self = this.$app.dialog.alert('Hello world!');
      },
	  initUI:function(){
	     console.log('init ui');
		 var _this=this;
		 //init calendar
		 var monthNames =j2Utils.monthNames;
			calendarInline = app.calendar.create({
			  containerEl: '#demo-calendar-inline-container',
			  value: [new Date()],
			  dayNamesShort:j2Utils.dayNames,
			  weekHeader: true,
			  renderToolbar: function () {
				return '<div class="toolbar calendar-custom-toolbar no-shadow">' +
				  '<div class="toolbar-inner">' +
					'<div class="left">' +
					  '<a href="#" class="link icon-only"><i class="icon icon-back ' + (app.theme === 'md' ? 'color-black' : '') + '"></i></a>' +
					'</div>' +
					'<div class="center"></div>' +
					'<div class="right">' +
					  '<a href="#" class="link icon-only"><i class="icon icon-forward ' + (app.theme === 'md' ? 'color-black' : '') + '"></i></a>' +
					'</div>' +
				  '</div>' +
				'</div>';
			  },
			  on: {
				init: function (c) {
				  $$('.calendar-custom-toolbar .center').text(monthNames[c.currentMonth] +', ' + c.currentYear);
				  $$('.calendar-custom-toolbar .left .link').on('click', function () {
					calendarInline.prevMonth();
				  });
				  $$('.calendar-custom-toolbar .right .link').on('click', function () {
					calendarInline.nextMonth();
				  });
				},
				monthYearChangeStart: function (c) {
				  $$('.calendar-custom-toolbar .center').text(monthNames[c.currentMonth] +', ' + c.currentYear);
				},
				calendarDayClick:function(calendar, dayEl, year, month, day){
				 // _this.selectedDate=calendar.getValue()[0];
				 var mo=parseInt(month)+1;
				 var selDate=year+"/"+mo+"/"+day;
				 _this.selectedDate=new Date(selDate);
				  _this.statusChanged();
				}
			  }
			});
			//init virtual list
			var items = [];
			virtualList = app.virtualList.create({
			  // List Element
			  el: '.virtual-list',
			  // Pass array with items
			  items: items,
			  // Custom search function for searchbar
			  searchAll: function (query, items) {
				var found = [];
				for (var i = 0; i < items.length; i++) {
				  if (items[i].title.toLowerCase().indexOf(query.toLowerCase()) >= 0 || query.trim() === '') found.push(i);
				}
				return found; //return array with mathced indexes
			  },
			  // List item Template7 template
			  itemTemplate:$$('script#virtualListTpl').html(),
		
			  // Item height
			  height: app.theme === 'ios' ? 83 : 93
			});
	  },
	 initUIData:function(){
	    var _this=this;
	    var ss=app.smartSelect.get('#ss-user-list');
		var ssSelect=$$('#ss-user-list select');
		//ssSelect[0].options.length=0;
		  app.request.post(app.data.baseURL+'/api/jsonws/invoke', this.userlistParam, function (data) {
			  var res=JSON.parse(data);
			  var rows=res.rows;
			  for (var i = 0; i <rows.length; i++) {
				  _this.users.push({
					id:rows[i].userId,
					uname: rows[i].firstName,
					teamName:rows[i].teamName
				  });
				  //ssSelect[0].options.add(new Option(rows[i].firstName,rows[i].userId));
				}
				 var userListTpl = $$('script#userListTpl').html();
                 var compiledUserListTpl = Template7.compile(userListTpl);
				 var context={
				  userId:app.data.userId,
				  users : _this.users
				  }; 
				  var newSelect = compiledUserListTpl(context);
				  var ssSelect=$$('#ss-user-list select').html(newSelect);
				
		   });
			ss.on('close', function(smartSelect){
			    var selUserId = $$('#ss-user-list select').val();
				_this.selectedUserId=selUserId!=""?selUserId:_this.selectedUserId;
				_this.statusChanged();
			});
	 },
	  //
	  statusChanged:function(){
	         
			     var currentWeekDays=j2Utils.getWeekDays(this.selectedDate);
				 var defaultStartTime=currentWeekDays[0].day.format('x');
				 var defaultEndTime=currentWeekDays[6].day.add(1, 'days').format('x');
				 
				 this.listParam.startTime=defaultStartTime;
				 this.listParam.endTime=defaultEndTime;
				 this.listParam.userId=this.selectedUserId!=''?this.selectedUserId:app.data.userId;
				 
			   app.request.post(app.data.baseURL+'/api/jsonws/invoke', this.listParam, function (data) {
				  var res=JSON.parse(data);
				  var rows=res.rows;
				  var items = [];
				  for (var i = 0; i <rows.length; i++) {
				       var dr= moment.duration(rows[i].duration).asHours();
				       var week=moment(Number(rows[i].startTime)).format('dddd')
                       var timeTag=week+'(' + dr+'H)' ;
					  items.push({
					    id:rows[i].bookingId,
						title: rows[i].title,
						description:rows[i].description,
						timeTag:timeTag
					  });
					}
					//fire data list changed
					virtualList.replaceAllItems(items);
			   });
	  },
	  //
    }
  }

</script>
